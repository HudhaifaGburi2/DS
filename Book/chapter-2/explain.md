# 01. ูู ุงููููุงุช ุฅูู ููุงุนุฏ ุงูุจูุงูุงุช

## ุงูููุฏูุฉ
ููุจุฏุฃ ุจูุดููุฉ ุชุจุฏู ุจุณูุทุฉ: ุญูุธ ุงูุจูุงูุงุช ูู ููู ููุญุงููุฉ ุฌุนููุง ุฐุฑูุฉ (atomic) ูุฏุงุฆูุฉ (durable)ุ ุฃู ููุงููุฉ ููุฃุนุทุงู ูุงูุงูููุงุฑุงุช.

---

## 1.1 ุชุญุฏูุซ ุงููููุงุช ูู ููุณ ุงูููุงู (In-place Updates)

ุงูุทุฑููุฉ ุงูุชูููุฏูุฉ ูุญูุธ ููู ูุงููุชุงุจุฉ ูููู:

```go
func SaveData1(path string, data []byte) error {
    // ูุชุญ ุงูููู ูููุชุงุจุฉ ููุทุ ุฅูุดุงุคู ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ูุญุฐู ูุญุชูุงู ุงููุฏูู
    fp, err := os.OpenFile(path, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, 0664)
    if err != nil {
        return err
    }
    defer fp.Close()

    // ูุชุงุจุฉ ุงูุจูุงูุงุช ุฅูู ุงูููู
    _, err = fp.Write(data)
    if err != nil {
        return err
    }
    
    // fsync: ุงูุชุฃูุฏ ูู ูุชุงุจุฉ ุงูุจูุงูุงุช ูุนููุงู ุนูู ุงููุฑุต ุงูุตูุจ
    return fp.Sync()
}
```

**ุงูุดุฑุญ:**
- ูุฐู ุงูุทุฑููุฉ ุชุณุชุฎุฏู ูุธุงู ุงููููุงุช ููุงุนุฏุฉ ุจูุงูุงุช Key-Value ุจุณูุทุฉ
- ุงุณู ุงูููู = ุงูููุชุงุญ (Key)
- ูุญุชูู ุงูููู = ุงููููุฉ (Value)
- `O_CREATE`: ููุดุฆ ุงูููู ุฅุฐุง ูู ููู ููุฌูุฏุงู
- `O_TRUNC`: ูุญุฐู ุงููุญุชูู ุงูุณุงุจู ุฅุฐุง ูุงู ุงูููู ููุฌูุฏุงู
- `fsync`: ุงุณุชุฏุนุงุก ูุธุงู ูุทูุจ ููุคูุฏ ุฃู ุงูุจูุงูุงุช ููุชุจุช ูุนููุงู

**ุงููุดููุฉ:**
ูุฐู ุงูุทุฑููุฉ **ุชูุดู** ูู ุชุญููู ูุชุทูุจุงุช ุงูุฐุฑูุฉ ูุงูุฏููููุฉ:
- ุญุฐู ูุญุชูู ุงูููู (truncate) ูุฏ ูุคุฏู ุฅูู ููู ูุงุฑุบ ุนูุฏ ุญุฏูุซ ุนุทู
- ุนุฏู ุงูุญุฐู ูุฏ ูุคุฏู ุฅูู ููู ููุชูุจ ุฌุฒุฆูุงู

---

## 1.2 ุฅุนุงุฏุฉ ุงูุชุณููุฉ ุงูุฐุฑูุฉ (Atomic Renaming)

**ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุจุดูู ุฐุฑู ุนุจุฑ ุฅุนุงุฏุฉ ุชุณููุฉ ุงููููุงุช**

ูุชุฌูุจ ุงูุชุญุฏูุซ ูู ููุณ ุงูููุงูุ ููุชุจ ูุณุฎุฉ ุฌุฏูุฏุฉ ูู ุงูุจูุงูุงุช ุซู ููุชูู ุฅูููุง ุจุดูู ุฐุฑู. ุนูููุฉ "ุงูุชุจุฏูู" ูู `rename()` ูู ูุธุงู ุงููููุงุช.

```
โโโโโ  ุฅูุดุงุก   โโโโโ   โโโโโ  ุฅุนุงุฏุฉ ุชุณููุฉ   โโโโโ
โ 1 โ โโโโโ  โ 1 โ + โ 2 โ โโโโโโโโโโ  โ 2 โ
โโโโโ         โโโโโ   โโโโโ              โโโโโ
 ูุฏูู          ูุฏูู    ูุคูุช              ุฌุฏูุฏ
```

```go
func SaveData2(path string, data []byte) error {
    // 1. ุฅูุดุงุก ุงุณู ููู ูุคูุช ูุฑูุฏ
    tmp := fmt.Sprintf("%s.tmp.%d", path, randomInt())
    
    // 2. ูุชุญ ุงูููู ุงููุคูุช (O_EXCL ูุถูู ุนุฏู ุงููุชุงุจุฉ ููู ููู ููุฌูุฏ)
    fp, err := os.OpenFile(tmp, os.O_WRONLY|os.O_CREATE|os.O_EXCL, 0664)
    if err != nil {
        return err
    }
    
    // 4. ุชูุธูู: ุญุฐู ุงูููู ุงููุคูุช ุฅุฐุง ูุดูุช ุงูุนูููุฉ
    defer func() {
        fp.Close() // ูู ุงูููุชุฑุถ ุฃูุง ููุดู
        if err != nil {
            os.Remove(tmp) // ุญุฐู ุงูููู ุงููุคูุช ุนูุฏ ุงููุดู
        }
    }()

    // 1. ุญูุธ ุงูุจูุงูุงุช ูู ุงูููู ุงููุคูุช
    if _, err = fp.Write(data); err != nil {
        return err
    }
    
    // 2. fsync ููุชุฃูุฏ ูู ูุชุงุจุฉ ุงูุจูุงูุงุช
    if err = fp.Sync(); err != nil {
        return err
    }
    
    // 3. ุงุณุชุจุฏุงู ุงูููู ุงููุฏู ุจุงูููู ุงููุคูุช (ุนูููุฉ ุฐุฑูุฉ)
    err = os.Rename(tmp, path)
    return err
}
```

### ุฃููุงุน ุงูุฐุฑูุฉ (Atomicity)

**ุงูุฐุฑูุฉ** ููุง ูุนุงูู ูุฎุชููุฉ:

1. **ุฐุฑูุฉ ููุงููุฉ ูุงููุทุงุน ุงูุทุงูุฉ (Power-loss atomic)**: ูู ุณูุฑู ุงููุงุฑุฆ ุญุงูุฉ ุณูุฆุฉ ุจุนุฏ ุนุทูุ
2. **ุฐุฑูุฉ ุงููุฑุงุก-ุงููุงุชุจ (Readers-writer atomic)**: ูู ุณูุฑู ุงููุงุฑุฆ ุญุงูุฉ ุณูุฆุฉ ูุน ูุฌูุฏ ูุงุชุจ ูุชุฒุงููุ

- `SaveData1` ุชูุดู ูู **ููุง ุงูููุนูู**
- `SaveData2` ุชุญูู ุฐุฑูุฉ ุงููุฑุงุก-ุงููุงุชุจุ ููู **ููุณุช ููุงููุฉ ูุงููุทุงุน ุงูุทุงูุฉ**!

### ููุงุฐุง ุชุนูู ุฅุนุงุฏุฉ ุงูุชุณููุฉุ

- ุฃูุธูุฉ ุงููููุงุช ุชุญุชูุธ ุจุชุนููู ูู ุฃุณูุงุก ุงููููุงุช ุฅูู ุจูุงูุงุช ุงููููุงุช (mapping)
- ุงุณุชุจุฏุงู ููู ุนุจุฑ ุฅุนุงุฏุฉ ุงูุชุณููุฉ ููุดูุฑ ุงุณู ุงูููู ุฅูู ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุฏูู ููุณ ุงูุจูุงูุงุช ุงููุฏููุฉ
- ูุฐุง ุงูุชุนููู ูู "ุงูุฏููู" (directory)
- ููููู "ุงูุฑูุงุจุท ุงูุตูุจุฉ" (hard links): ูููุงุช ูุชุนุฏุฏุฉ ุชุดูุฑ ูููุณ ุงูุจูุงูุงุช

**ุงููุดููุฉ:**
- ุฐุฑูุฉ ูุฏูุงู `rename()` ุชุนุชูุฏ ุนูู ุชุญุฏูุซุงุช ุงูุฏููู
- ุชุญุฏูุซ ุงูุฏููู ุฐุฑู ูููุฑุงุก-ุงููุงุชุจ ููุทุ **ููุณ ููุงููุงู ูุงููุทุงุน ุงูุทุงูุฉ**
- ูุฐุง `SaveData2` ูุง ุชุฒุงู ุบูุฑ ุตุญูุญุฉ!

### ูุดุงูู fsync

- ุฅูุดุงุก ููู ูุฅุนุงุฏุฉ ุชุณููุชู ููุญุฏูุซุงู ุงูุฏููู ุงููุญุชูู
- **ุงูุญู**: ูุฌุจ ุงุณุชุฏุนุงุก `fsync` ุนูู ุงูุฏููู ุฃูุถุงู
- **ูุดููุฉ ุฃุฎุฑู**: ุฅุฐุง ูุดู `fsync`ุ ูุฏ ุชูุฑุฃ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ (ูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช) ุฑุบู ูุดู ุงูุนูููุฉ!

---

## 1.3 ุณุฌูุงุช ุงูุฅูุญุงู ููุท (Append-only Logs)

### ุงูุชุญุฏูุซุงุช ุงูุชุฏุฑูุฌูุฉ ุจุงุณุชุฎุฏุงู ุงูุณุฌูุงุช

ุงูุณุฌู (log) ูุฎุฒู ูุงุฆูุฉ ูุฑุชุจุฉ ูู ุฃูุตุงู ูู ุชุญุฏูุซ. ูููู ุฅุนุงุฏุฉ ุจูุงุก ุงูุญุงูุฉ ุงููุงููุฉ ุจุชูุณูุฑ ูู ุฅุฏุฎุงู.

**ูุซุงู: ุณุฌู ูุชุญุฏูุซุงุช Key-Value**

```
     0         1         2        3
| set a=1 | set b=2 | set a=3 | del b |
```

ุงูุญุงูุฉ ุงูููุงุฆูุฉ: `a=3`

### ุงูุชุญุฏูุซุงุช ุงูุฐุฑูุฉ ููุณุฌู ุจุงุณุชุฎุฏุงู ุงููุฌุงููุน ุงูุงุฎุชุจุงุฑูุฉ (Checksums)

- ููุชุฑุถ ุฃู ุงูุณุฌู ููููู ุงูููู ููุท (append-only)
- ูู ุฅูุญุงู ููุฌุนู ุฏุงุฆูุงู ุจู `fsync`
- ุฅุฐุง ุญุฏุซ ุนุทู ุจูู ุงูุฅูุญุงู ู`fsync`ุ ูุฏ ูููู ุงูุฅุฏุฎุงู ุงูุฃุฎูุฑ ููุชูุจุงู ุฌุฒุฆูุงู
- **ุงูุญู**: ุฅุถุงูุฉ checksum ููู ุฅุฏุฎุงู
- ุฑุฃุณ (header) ุจุญุฌู ุซุงุจุช ูุญุชูู ุนูู: ุญุฌู ุงูุฅุฏุฎุงู + checksum
- ุนูุฏ ุงูุงุณุชุฑุฏุงุฏ: ูุญุต ุงูุฅุฏุฎุงู ุงูุฃุฎูุฑุ ุฅุฐุง ูุงู ุงูุญุฌู ุฃู checksum ุฎุงุทุฆุงูุ ูุชู ุชุฌุงููู

**ููุงุญุธุฉ ูููุฉ:**
- Checksums ููุง **ููุณุช** ูููุดู ุนู ุชูู ุงูุจูุงูุงุช ุงูุตุงูุช (silent data corruption)
- ุงููุฏู ุงููุญูุฏ: ูุดู ุงููุชุงุจุงุช ุบูุฑ ุงููุงููุฉ (torn writes)

### ุงูุณุฌู ููููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

- ุงูุณุฌู **ููุณ** ูุงุนุฏุฉ ุจูุงูุงุช ูุงููุฉ
- ูุฌุจ ุฏูุฌู ูุน ุจููุฉ ุจูุงูุงุช ุงูููุฑุณุฉ
- ุฅุฏุฎุงูุงุช ุงูุณุฌู ุชูุฏูุฌ ูุน ุจููุฉ ุงูุจูุงูุงุช ุนูุฏูุง ููุจุฑ ุงูุณุฌู
- ูุฐุง ูุญู ูุดููุฉ ุงูููู ุงููุงููุงุฆู
- ุงููุดููุฉ ุงููุชุจููุฉ: ููููุฉ ุชุญุฏูุซ ุจููุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ ุจุดูู ุฐุฑู

---

## 1.4 ููุฎุต ุชุญุฏูุงุช ููุงุนุฏ ุงูุจูุงูุงุช

### ูุง ุชุนูููุงู:

1. **ูุดุงูู ุงูุชุญุฏูุซ ูู ููุณ ุงูููุงู:**
   - ุชุฌูุจูุง ุจุฅุนุงุฏุฉ ุชุณููุฉ ุงููููุงุช
   - ุชุฌูุจูุง ุจุงุณุชุฎุฏุงู ุงูุณุฌูุงุช

2. **ุณุฌูุงุช ุงูุฅูุญุงู ููุท:**
   - ุชุญุฏูุซุงุช ุชุฏุฑูุฌูุฉ
   - ููุณุช ุญูุงู ูุงููุงู (ูุง ููุฑุณุฉ ููุง ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ูููุณุงุญุฉ)

3. **ุงุณุชุฎุฏุงู fsync:**
   - ุจูุงูุงุช ุงูููู ูุงูุฏููู ูุญุชุงุฌุงู fsync

### ูุง ูุจูู ุณุคุงูุงู:

- ุจูู ุจูุงูุงุช ุงูููุฑุณุฉ
- ุฏูุฌ ุงูุณุฌู ูุน ุจููุฉ ุจูุงูุงุช ุงูููุฑุณุฉ
- ุงูุชุฒุงูู (Concurrency)

---

## ๐ ููุฎุต ุงูุฃููุงุฑ ุงูุฑุฆูุณูุฉ

### ูุง ูุฑูุฏ ุงููุคูู ุฅูุตุงูู:

1. **ุงูุงูุชูุงู ูู ุงูุจุณุงุทุฉ ุฅูู ุงูุชุนููุฏ**: ุจูุงุก ูุงุนุฏุฉ ุจูุงูุงุช ูุจุฏุฃ ูู ูุดููุฉ ุจุณูุทุฉ (ุญูุธ ููู) ููุชุทูุฑ ุฅูู ุญููู ูุนูุฏุฉ

2. **ุงูุฐุฑูุฉ ููุณุช ูุฌุงููุฉ**: ุชุญููู ุนูููุงุช ุฐุฑูุฉ ูุชุทูุจ ูููุงู ุนูููุงู ููุธุงู ุงููููุงุช ู`fsync`

3. **ุงูุชุทูุฑ ุงูุชุฏุฑูุฌู ููุญููู**:
   - ุงูุจุฏุงูุฉ: ูุชุงุจุฉ ูุจุงุดุฑุฉ (ูุงุดูุฉ)
   - ุงูุชุญุณูู: ุฅุนุงุฏุฉ ุงูุชุณููุฉ (ุฃูุถู ููู ูุงูุตุฉ)
   - ุงูุญู ุงููุชูุฏู: ุงูุณุฌูุงุช + Checksums

### ๐ ุชุฃุซูุฑ ูุฐู ุงูููุงููู ูู ุชุทุจููุงุช ููุงุนุฏ ุงูุจูุงูุงุช ุงูุญููููุฉ:

#### **PostgreSQL:**
- ุชุณุชุฎุฏู WAL (Write-Ahead Log) - ุณุฌู ูุชุงุจุฉ ูุณุจู
- ูู ุชุญุฏูุซ ูููุชุจ ูู ุงูุณุฌู ุฃููุงู ูุจู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ
- ุชุทุจูู ูุจุงุดุฑ ูููููู append-only logs

#### **MySQL (InnoDB):**
- ุชุณุชุฎุฏู ุณุฌููู: redo log ู binary log
- redo log ููุงุณุชุฑุฏุงุฏ ูู ุงูุฃุนุทุงู
- binary log ูููุณุฎ ุงููุชูุงุซู (replication)

#### **SQLite:**
- ุชุณุชุฎุฏู rollback journal ุฃู WAL mode
- ูู WAL modeุ ุชุทุจู ููุณ ูุจุงุฏุฆ ุงูุณุฌูุงุช ุงูุชู ุดุฑุญูุง ุงููุคูู

#### **MongoDB:**
- WiredTiger engine ูุณุชุฎุฏู checkpoints + journal
- Journal = append-only log ููุฏููููุฉ

### ๐ ุงูุนูุงูุฉ ุจูุฌุงูุงุช ุฃุฎุฑู:

#### **ุฃูุธูุฉ ุงููููุงุช ุงูููุฒุนุฉ:**
- HDFSุ GFS ุชุณุชุฎุฏู append-only logs
- ููุณ ูุจุฏุฃ ุชุฌูุจ ุงูุชุญุฏูุซุงุช ูู ููุณ ุงูููุงู

#### **Blockchain:**
- ุงูุณูุณูุฉ ููุณูุง append-only log
- ูู ูุชูุฉ ุชุญุชูู ุนูู hash (ููุน ูู checksum)

#### **Event Sourcing:**
- ููุท ูุนูุงุฑู ูุฎุฒู ูู ุงูุชุบููุฑุงุช ูุฃุญุฏุงุซ (events)
- ุชุทุจูู ูุจุงุดุฑ ูููููู ุงูุณุฌูุงุช

#### **Git ู Version Control:**
- Git ูุฎุฒู commits ูุณูุณูุฉ ูู ุงูุชุบููุฑุงุช
- ูู commit ูู hash (checksum)
- ููููู ูุดุงุจู ููู append-only logs

### ๐ก ุงูุฏุฑูุณ ุงูุนูููุฉ:

1. **ูุง ุชุซู ุจุงูุจุณุงุทุฉ ุงูุธุงูุฑุฉ**: ุญูุธ ููู ููุณ ุจุณูุทุงู ููุง ูุจุฏู
2. **ุงูุฃุฏุงุก ููุงุจู ุงูุตุญุฉ**: `fsync` ุจุทูุก ูููู ุถุฑูุฑู ููุฏููููุฉ
3. **ุงูุทุจูุงุช ุงููุชุนุฏุฏุฉ**: ููู ูู ุทุจูุฉ (OS cacheุ device RAMุ disk) ุถุฑูุฑู
4. **ุงููุญุต ูุงูุงุณุชุฑุฏุงุฏ**: ุฏุงุฆูุงู ุฎุทุท ูุณููุงุฑูู ุงููุดู (checksumsุ recovery)

### ๐ฏ ุงูุฃุณุฆูุฉ ุงูููุชูุญุฉ ูููุตูู ุงููุงุฏูุฉ:

- ููู ูุจูู ููุงุฑุณ ูุนุงูุฉุ (B-treesุ LSM-trees)
- ููู ูุฏูุฌ ุงูุณุฌูุงุช ูุน ุจูู ุงูุจูุงูุงุชุ
- ููู ูุชุนุงูู ูุน ุงูุชุฒุงูู ูุงููุฑุงุกุงุช/ุงููุชุงุจุงุช ุงููุชุฒุงููุฉุ
- ููู ูุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ ููุนูุฏ ุงุณุชุฎุฏุงู ุงููุณุงุญุฉุ